name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  powershell-analysis:
    name: PowerShell Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PowerShell modules
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          
          # NetApp.ONTAP ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          try {
            Install-Module -Name NetApp.ONTAP -Force -Scope CurrentUser -ErrorAction Stop
            Write-Host "âœ“ NetApp.ONTAP ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ" -ForegroundColor Green
          } catch {
            Write-Warning "NetApp.ONTAP ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ: $($_.Exception.Message)"
          }

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Write-Host "ğŸ” PSScriptAnalyzer ã‚’å®Ÿè¡Œä¸­..." -ForegroundColor Cyan
          
          # PSGalleryè¨­å®šã‚’ä½¿ç”¨ã—ã¦è§£æ
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Settings PSGallery
          
          if ($results) {
            Write-Host "`nPSScriptAnalyzer ãŒ $($results.Count) ä»¶ã®å•é¡Œã‚’æ¤œå‡ºã—ã¾ã—ãŸ:" -ForegroundColor Yellow
            $results | Format-Table -AutoSize
            
            $errors = $results | Where-Object { $_.Severity -eq 'Error' }
            if ($errors) {
              Write-Host "`nâŒ $($errors.Count) ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ“ãƒ«ãƒ‰å¤±æ•—ã€‚" -ForegroundColor Red
              exit 1
            }
            
            $warnings = $results | Where-Object { $_.Severity -eq 'Warning' }
            if ($warnings) {
              Write-Host "`nâš ï¸  $($warnings.Count) ä»¶ã®è­¦å‘ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚" -ForegroundColor Yellow
            }
          } else {
            Write-Host "`nâœ… å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼" -ForegroundColor Green
          }

      - name: Check PowerShell syntax
        shell: pwsh
        run: |
          Write-Host "ğŸ“ PowerShell æ§‹æ–‡ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..." -ForegroundColor Cyan
          
          $files = Get-ChildItem -Path . -Include *.ps1,*.psm1 -Recurse | 
                   Where-Object { $_.FullName -notmatch '[\\/]\.git[\\/]' }
          $errors = @()
          
          foreach ($file in $files) {
            try {
              $null = [System.Management.Automation.Language.Parser]::ParseFile(
                $file.FullName,
                [ref]$null,
                [ref]$null
              )
              Write-Host "  âœ… $($file.Name)" -ForegroundColor Green
            } catch {
              Write-Host "  âŒ $($file.Name): $($_.Exception.Message)" -ForegroundColor Red
              $errors += $file.Name
            }
          }
          
          if ($errors.Count -gt 0) {
            Write-Host "`nâŒ $($errors.Count) ãƒ•ã‚¡ã‚¤ãƒ«ã§æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ" -ForegroundColor Red
            exit 1
          } else {
            Write-Host "`nâœ… ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãŒæ­£ã—ã„ã§ã™" -ForegroundColor Green
          }

  json-validation:
    name: JSON Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate JSON files
        shell: pwsh
        run: |
          Write-Host "ğŸ“„ JSON è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ä¸­..." -ForegroundColor Cyan
          
          $jsonFiles = Get-ChildItem -Path config -Filter *.json -ErrorAction SilentlyContinue
          
          if (-not $jsonFiles) {
            Write-Host "âš ï¸  config ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" -ForegroundColor Yellow
            exit 0
          }
          
          $errors = @()
          
          foreach ($file in $jsonFiles) {
            try {
              $null = Get-Content -Path $file.FullName -Raw | ConvertFrom-Json -ErrorAction Stop
              Write-Host "  âœ… $($file.Name)" -ForegroundColor Green
            } catch {
              Write-Host "  âŒ $($file.Name): $($_.Exception.Message)" -ForegroundColor Red
              $errors += $file.Name
            }
          }
          
          if ($errors.Count -gt 0) {
            Write-Host "`nâŒ $($errors.Count) ãƒ•ã‚¡ã‚¤ãƒ«ã§JSONæ¤œè¨¼ãŒå¤±æ•—ã—ã¾ã—ãŸ" -ForegroundColor Red
            exit 1
          } else {
            Write-Host "`nâœ… ã™ã¹ã¦ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ‰åŠ¹ã§ã™" -ForegroundColor Green
          }
