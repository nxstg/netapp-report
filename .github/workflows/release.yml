name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v2.1.3 ãªã©ã®ã‚¿ã‚°ã«ãƒãƒƒãƒ

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆã«ä½¿ç”¨

      - name: Get version from tag
        id: get_version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "VERSION_WITHOUT_V=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create release archive
        run: |
          mkdir -p release-package
          
          # ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          cp netapp-report.ps1 release-package/
          cp README.md release-package/
          cp LICENSE release-package/
          cp .gitignore release-package/
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚³ãƒ”ãƒ¼
          cp -r config release-package/
          cp -r modules release-package/
          
          # reportsã¨logsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹é€ ã‚’ä½œæˆï¼ˆç©ºï¼‰
          mkdir -p release-package/reports
          mkdir -p release-package/logs
          touch release-package/reports/.gitkeep
          touch release-package/logs/.gitkeep
          
          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
          cd release-package
          zip -r ../netapp-report-${{ steps.get_version.outputs.VERSION_WITHOUT_V }}.zip .
          tar -czf ../netapp-report-${{ steps.get_version.outputs.VERSION_WITHOUT_V }}.tar.gz .
          cd ..

      - name: Generate Release Notes
        id: release_notes
        run: |
          # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # æœ€åˆã®ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆ
            echo "NOTES<<EOF" >> $GITHUB_OUTPUT
            echo "## ğŸ‰ Initial Release" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "NetApp ONTAP Report Generator ã®æœ€åˆã®ãƒªãƒªãƒ¼ã‚¹ã§ã™ã€‚" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### ğŸ¯ ä¸»ãªç‰¹å¾´" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- âœ… **åŒ…æ‹¬çš„ãªæƒ…å ±åé›†** - ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã€ãƒãƒ¼ãƒ‰ã€ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã€LIFã€ãƒãƒ¼ãƒˆã€ãƒ‡ã‚£ã‚¹ã‚¯æƒ…å ±ã‚’åé›†" >> $GITHUB_OUTPUT
            echo "- âœ… **å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯** - ãƒªã‚½ãƒ¼ã‚¹ã®é–¾å€¤ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹åˆ¤å®šã¨ç•°å¸¸æ¤œçŸ¥" >> $GITHUB_OUTPUT
            echo "- âœ… **ãƒ‡ã‚£ã‚¹ã‚¯æƒ…å ±ãƒ¬ãƒãƒ¼ãƒˆ** - å…¨ãƒ‡ã‚£ã‚¹ã‚¯æƒ…å ±ã®å–å¾—ã€ã‚¹ãƒšã‚¢ãƒ‡ã‚£ã‚¹ã‚¯ã®ã‚¼ãƒ­ã‚¤ãƒ³ã‚°çŠ¶æ…‹ç¢ºèª" >> $GITHUB_OUTPUT
            echo "- âœ… **è¤‡æ•°å‡ºåŠ›å½¢å¼** - JSONã€HTMLã€CSVå½¢å¼ã§ã®ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›" >> $GITHUB_OUTPUT
            echo "- âœ… **ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½** - HTMLãƒ¬ãƒãƒ¼ãƒˆã®è‡ªå‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡" >> $GITHUB_OUTPUT
            echo "- âœ… **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–è¨­è¨ˆ** - ä¿å®ˆæ€§ã¨æ‹¡å¼µæ€§ã«å„ªã‚ŒãŸæ§‹é€ " >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### ğŸ“‹ å¿…è¦è¦ä»¶" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- PowerShell 5.1 ä»¥ä¸Š" >> $GITHUB_OUTPUT
            echo "- NetApp.ONTAP ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«" >> $GITHUB_OUTPUT
            echo "- NetApp ONTAP ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "\`\`\`powershell" >> $GITHUB_OUTPUT
            echo "# NetApp.ONTAP ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«" >> $GITHUB_OUTPUT
            echo "Install-Module -Name NetApp.ONTAP -Scope CurrentUser" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "# ãƒªãƒªãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹" >> $GITHUB_OUTPUT
            echo "# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦å®Ÿè¡Œ" >> $GITHUB_OUTPUT
            echo "./netapp-report.ps1" >> $GITHUB_OUTPUT
            echo "\`\`\`" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "è©³ç´°ã¯ [README.md](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.VERSION }}/README.md) ã‚’ã”è¦§ãã ã•ã„ã€‚" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            # å‰å›ã®ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ã®å¤‰æ›´ã‚’å–å¾—
            echo "NOTES<<EOF" >> $GITHUB_OUTPUT
            echo "## ğŸ“ Changes since ${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "è©³ç´°ã¯ [README.md](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.VERSION }}/README.md) ã‚’ã”è¦§ãã ã•ã„ã€‚" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: ${{ steps.release_notes.outputs.NOTES }}
          draft: false
          prerelease: false
          files: |
            netapp-report-${{ steps.get_version.outputs.VERSION_WITHOUT_V }}.zip
            netapp-report-${{ steps.get_version.outputs.VERSION_WITHOUT_V }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version badge
        run: |
          echo "âœ… Release ${{ steps.get_version.outputs.VERSION }} created successfully!"
