name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 9:00 (UTC) ã«å®Ÿè¡Œ
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check PowerShell module versions
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ PowerShell ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèªä¸­..." -ForegroundColor Cyan
          
          # NetApp.ONTAPã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
          Write-Host "`nNetApp.ONTAP:" -ForegroundColor Yellow
          try {
            $availableVersions = Find-Module -Name NetApp.ONTAP -AllVersions -ErrorAction Stop | Select-Object -First 5
            $availableVersions | Format-Table Name, Version, PublishedDate -AutoSize
          } catch {
            Write-Warning "NetApp.ONTAP ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          }
          
          # PSScriptAnalyzerã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
          Write-Host "`nPSScriptAnalyzer:" -ForegroundColor Yellow
          $availableVersions = Find-Module -Name PSScriptAnalyzer -AllVersions | Select-Object -First 5
          $availableVersions | Format-Table Name, Version, PublishedDate -AutoSize

  vulnerability-scan:
    name: Custom Security Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for security issues
        shell: pwsh
        run: |
          Write-Host "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­..." -ForegroundColor Cyan
          
          $issues = @()
          $warnings = @()
          
          # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯
          Write-Host "`n1. ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯..." -ForegroundColor Yellow
          $credentialPatterns = @(
            @{ Pattern = 'password\s*=\s*[''"](?!.*example|.*placeholder|.*YourPassword)[^''"]{8,}[''"]'; Description = 'ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰' },
            @{ Pattern = 'api[_-]?key\s*=\s*[''"](?!.*example|.*placeholder)[^''"]+[''"]'; Description = 'APIã‚­ãƒ¼' },
            @{ Pattern = 'secret\s*=\s*[''"](?!.*example|.*placeholder)[^''"]+[''"]'; Description = 'ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ' },
            @{ Pattern = 'token\s*=\s*[''"](?!.*example|.*placeholder)[^''"]+[''"]'; Description = 'ãƒˆãƒ¼ã‚¯ãƒ³' }
          )
          
          $files = Get-ChildItem -Path . -Include *.ps1,*.psm1,*.json -Recurse | 
                   Where-Object { $_.FullName -notmatch '[\\/]\.git[\\/]' }
          
          foreach ($file in $files) {
            $content = Get-Content -Path $file.FullName -Raw
            foreach ($pattern in $credentialPatterns) {
              if ($content -match $pattern.Pattern) {
                $issues += "âš ï¸  $($pattern.Description) ãŒæ¤œå‡ºã•ã‚ŒãŸå¯èƒ½æ€§: $($file.FullName)"
              }
            }
          }
          
          # å®‰å…¨ã§ãªã„é–¢æ•°ã®ä½¿ç”¨ãƒã‚§ãƒƒã‚¯
          Write-Host "`n2. å®‰å…¨ã§ãªã„é–¢æ•°ã®ä½¿ç”¨ãƒã‚§ãƒƒã‚¯..." -ForegroundColor Yellow
          $unsafeFunctions = @(
            @{ Pattern = 'ConvertTo-SecureString.*-AsPlainText.*-Force'; Description = 'ConvertTo-SecureString -AsPlainText -Force' },
            @{ Pattern = 'Invoke-Expression\s+\$'; Description = 'Invoke-Expression with variable' }
          )
          
          foreach ($file in $files) {
            $content = Get-Content -Path $file.FullName -Raw
            foreach ($func in $unsafeFunctions) {
              if ($content -match $func.Pattern) {
                $warnings += "â„¹ï¸  $($func.Description) ã®ä½¿ç”¨: $($file.FullName)"
              }
            }
          }
          
          # çµæœã®ã‚µãƒãƒªãƒ¼
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          
          if ($issues.Count -gt 0) {
            Write-Host "`nâŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:" -ForegroundColor Red
            $issues | ForEach-Object { Write-Host $_ -ForegroundColor Red }
            Write-Error "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„"
            exit 1
          } else {
            Write-Host "`nâœ… é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" -ForegroundColor Green
          }
          
          if ($warnings.Count -gt 0) {
            Write-Host "`nâš ï¸  æ³¨æ„äº‹é …:" -ForegroundColor Yellow
            $warnings | ForEach-Object { Write-Host $_ -ForegroundColor Yellow }
          }

  trivy-scan:
    name: Trivy Security Scanner
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  markdown-link-check:
    name: Markdown Link Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          check-modified-files-only: 'no'
